# .goreleaser/fedora.yml
# GoReleaser configuration for whereami - Fedora/RHEL specific
#
# This configuration builds the whereami application and packages it as RPM
# with Fedora/RHEL-specific Qt6 package names.

version: 2

# Set environment variables for the build
env:
  - CGO_ENABLED=1
  - PATH={{ .Env.PATH }}:/usr/lib64/qt6/libexec

# Run go generate before building
before:
  hooks:
    - go mod tidy
    - go generate ./...

# Build configuration
builds:
  - id: whereami
    main: .
    binary: whereami

    # Build flags
    flags:
      - -trimpath

    # Linker flags to reduce binary size
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser

    # Target platforms
    goos:
      - linux

    goarch:
      - amd64
      - arm64

    # Environment variables for each build
    env:
      - CGO_ENABLED=1
      - CC=gcc
      - CXX=g++

    # Specific environment for different architectures
    overrides:
      - goos: linux
        goarch: arm64
        env:
          - CC=aarch64-linux-gnu-gcc
          - CXX=aarch64-linux-gnu-g++

# Archive configuration
archives:
  - id: whereami-archive
    name_template: >-
      {{ .ProjectName }}_
      {{- .Version }}_
      {{- .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}

    # Use default format (tar.gz for linux, zip for windows)
    # format_overrides is deprecated, relying on defaults

    # Files to include in the archive
    files:
      - src: README.md
        dst: README.md
      - src: LICENSE
        dst: LICENSE
      - src: desktop/io.github.rubiojr.whereami.desktop
        dst: share/applications/io.github.rubiojr.whereami.desktop
      - src: ui/icons/io.github.rubiojr.whereami.svg
        dst: share/icons/hicolor/scalable/apps/io.github.rubiojr.whereami.svg

# Checksum configuration
checksum:
  name_template: "checksums.txt"
  algorithm: sha256

# RPM package configuration for Fedora/RHEL
nfpms:
  - id: whereami-fedora-rpm

    package_name: whereami
    file_name_template: >-
      {{ .PackageName }}-
      {{- .Version }}-
      {{- if .Prerelease }}0.{{ .Prerelease }}.{{ end }}
      {{- .Release }}.fc{{ .Env.FEDORA_VERSION }}.
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "arm64" }}aarch64
      {{- else if eq .Arch "386" }}i686
      {{- else }}{{ .Arch }}{{ end }}

    vendor: "WhereAmI Contributors"
    homepage: "https://github.com/rubiojr/whereami"
    maintainer: "Sergio Rubio <rubiojr@frameos.org>"
    description: |
      WhereAmI - View, manage and bookmark GPX waypoints with map display

      WhereAmI is a desktop mapping application that provides offline map viewing,
      waypoint management, GPX import/export, and location services integration.

    license: "MIT"

    formats:
      - rpm

    # RPM specific configuration
    rpm:
      summary: "Qt6/QML mapping application with waypoint management"
      group: "Applications/Productivity"
      compression: xz

    # Dependencies for Fedora/RHEL based on actual package names
    dependencies:
      # Core Qt6 libraries (Fedora package names)
      - qt6-qtbase
      - qt6-qtbase-gui
      - qt6-qtdeclarative
      - qt6-qtquickcontrols2
      - qt6-qtlocation
      - qt6-qtpositioning
      - qt6-qtsvg
      - qt6-qtimageformats
      - qt6-qtwayland

      # Additional Qt modules that might be needed
      - qt6-qtbase-common
      - qt6-qtquicktimeline
      - qt6-qt5compat

      # System libraries (most are auto-detected by RPM)
      - glibc
      - libstdc++
      - libgcc
      - zlib
      - fontconfig
      - freetype
      - libpng
      - harfbuzz
      - libX11
      - libxcb
      - libxkbcommon
      - mesa-libGL
      - mesa-libEGL
      - mesa-dri-drivers
      - dbus-libs
      - systemd-libs
      - pcre2
      - openssl-libs
      - libproxy
      - glib2
      - libxml2
      - bzip2-libs
      - libzstd
      - brotli

      # ICU for internationalization
      - libicu

      # Kerberos/GSSAPI (for network features)
      - krb5-libs

      # DBus for desktop integration
      - dbus-x11

    # Recommended packages (not required but enhance functionality)
    recommends:
      - geoclue2
      - qt6-qttranslations
      - qt6-qtgraphicaleffects-qt6
      - qt6-qtmultimedia

    # Suggested packages
    suggests:
      - gpsbabel

    # Provides
    provides:
      - whereami = {{ .Version }}

    # File contents
    contents:
      # Main binary
      - src: whereami
        dst: /usr/bin/whereami
        type: file
        file_info:
          mode: 0755

      # Desktop file
      - src: desktop/io.github.rubiojr.whereami.desktop
        dst: /usr/share/applications/io.github.rubiojr.whereami.desktop
        type: file
        file_info:
          mode: 0644

      # Icon files
      - src: ui/icons/io.github.rubiojr.whereami.svg
        dst: /usr/share/icons/hicolor/scalable/apps/io.github.rubiojr.whereami.svg
        type: file
        file_info:
          mode: 0644

      # Documentation
      - src: README.md
        dst: /usr/share/doc/whereami/README.md
        type: file
        file_info:
          mode: 0644

      - src: LICENSE
        dst: /usr/share/licenses/whereami/LICENSE
        type: file
        file_info:
          mode: 0644

      # Create required directories
      - dst: /usr/share/whereami
        type: dir
        file_info:
          mode: 0755

      - dst: /usr/share/doc/whereami
        type: dir
        file_info:
          mode: 0755

      - dst: /usr/share/licenses/whereami
        type: dir
        file_info:
          mode: 0755

    # Scripts to run during installation
    scripts:
      postinstall: |
        #!/bin/sh
        # Update desktop database
        if [ -x /usr/bin/update-desktop-database ]; then
          /usr/bin/update-desktop-database /usr/share/applications 2>/dev/null || :
        fi

        # Update icon cache
        if [ -x /usr/bin/gtk-update-icon-cache ]; then
          /usr/bin/gtk-update-icon-cache -q /usr/share/icons/hicolor 2>/dev/null || :
        fi

        # Update mime database if needed
        if [ -x /usr/bin/update-mime-database ]; then
          /usr/bin/update-mime-database /usr/share/mime 2>/dev/null || :
        fi

        # Create user data directory structure
        echo "WhereAmI installed successfully!"
        echo "First run will create configuration in ~/.config/whereami"
        echo "and cache in ~/.cache/whereami"

      postremove: |
        #!/bin/sh
        # Update desktop database
        if [ -x /usr/bin/update-desktop-database ]; then
          /usr/bin/update-desktop-database /usr/share/applications 2>/dev/null || :
        fi

        # Update icon cache
        if [ -x /usr/bin/gtk-update-icon-cache ]; then
          /usr/bin/gtk-update-icon-cache -q /usr/share/icons/hicolor 2>/dev/null || :
        fi

        # Note: We don't remove user config/cache directories

# Snapshot configuration for development builds
snapshot:
  version_template: "{{ .Tag }}"

# Release configuration
release:
  # GitHub release settings
  github:
    owner: rubiojr
    name: whereami

  # Release notes
  footer: |
    ## Installation on Fedora/RHEL/CentOS

    ### Install with DNF/YUM
    ```bash
    # Fedora
    sudo dnf install ./whereami-*.fc*.rpm

    # RHEL/CentOS/Rocky/Alma
    sudo yum install ./whereami-*.el*.rpm
    ```

    ### Install with RPM
    ```bash
    sudo rpm -Uvh whereami-*.rpm
    ```

    ## Requirements
    - Qt6 runtime libraries (automatically installed as dependencies)
    - OpenGL support (mesa drivers)
    - NetworkManager (for location services, optional)

    ## Troubleshooting

    If you encounter missing dependencies, install Qt6:
    ```bash
    # Fedora
    sudo dnf install qt6-qtbase qt6-qtdeclarative qt6-qtlocation qt6-qtpositioning

    # RHEL/CentOS 9+
    sudo dnf install qt6-qtbase qt6-qtdeclarative
    ```

  # Draft release by default
  draft: true

  # Prerelease mode
  prerelease: auto

  # Mode for release notes
  mode: append

  # Name template
  name_template: "{{.ProjectName}}-v{{.Version}}"

# Changelog generation
changelog:
  sort: asc
  use: github
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^ci:"
      - "^build:"
      - "^style:"
      - "^refactor:"
      - "^perf:"
      - "^Merge"
  groups:
    - title: "Features"
      regexp: '^.*?feat(\([[:word:]]+\))??!?:.+$'
      order: 0
    - title: "Bug Fixes"
      regexp: '^.*?fix(\([[:word:]]+\))??!?:.+$'
      order: 1
    - title: "Performance Improvements"
      regexp: '^.*?perf(\([[:word:]]+\))??!?:.+$'
      order: 2
    - title: "Other changes"
      order: 999

# Announce releases (optional)
announce:
  skip: true
